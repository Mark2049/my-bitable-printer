<!DOCTYPE html>
<html>
<head>
  <title>PDF 打印助手</title>
  <meta charset="UTF-8">
  <script src="https://lf1-cdn-tos.bytegoofy.com/goofy/bitable/sdk/bitable-sdk-2.3.6.js"></script>
  <style>
    /* 样式部分保持不变 */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
      padding: 15px;
      color: #333;
    }
    h3 {
      margin-top: 0;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    button:hover {
      background-color: #0056b3;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    #status {
      margin-top: 15px;
      font-size: 12px;
      color: #666;
    }
  </style>
</head>
<body>
  <h3>PDF 打印助手</h3>
  <p>点击下方按钮，将根据当前视图的数据生成一份可供打印的PDF文件。</p>

  <button id="printBtn">生成并打印</button>

  <p id="status">准备就绪</p>

  <script>
    // --- 这里是修正的部分 ---
    // 我们把所有代码都放进一个事件监听器里
    // 这会确保我们的代码在整个HTML页面都加载和解析完毕后才运行
    window.addEventListener('DOMContentLoaded', function() {

      // 将下面的URL替换成您Replit后端服务的URL
      const BACKEND_API_URL = 'https://YOUR_REPLIT_APP_NAME.replit.dev/api/generate-pdf/';

      const printBtn = document.getElementById('printBtn');
      const statusEl = document.getElementById('status');

      // 当按钮被点击时，执行这个函数
      printBtn.onclick = async function() {
        // 在使用 bitable 前，先检查它是否存在
        if (typeof bitable === 'undefined') {
          statusEl.textContent = '错误：无法连接到飞书表格环境，请刷新插件重试。';
          return;
        }

        try {
          statusEl.textContent = '1. 正在从表格获取数据...';
          printBtn.disabled = true;

          const selection = await bitable.base.getSelection();
          const table = await bitable.base.getTableById(selection.tableId);
          const recordIdList = await table.getRecordIdList({ viewId: selection.viewId });

          const records = [];
          for (const recordId of recordIdList) {
              records.push(await table.getRecord({ recordId }));
          }

          statusEl.textContent = `2. 已获取 ${records.length} 条记录，正在发送到后端生成PDF...`;

          const response = await fetch(BACKEND_API_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ records: records }),
          });

          if (!response.ok) {
              throw new Error(`服务器错误: ${response.status} ${response.statusText}`);
          }

          statusEl.textContent = '3. PDF生成成功，正在打开新标签页...';

          const pdfBlob = await response.blob();
          const pdfUrl = URL.createObjectURL(pdfBlob);

          window.open(pdfUrl, '_blank');

          statusEl.textContent = '完成！PDF已在新标签页中打开。';

        } catch (error) {
          statusEl.textContent = '发生错误: ' + error.message;
          console.error(error);
        } finally {
          printBtn.disabled = false;
        }
      }
    });
  </script>
</body>
</html>